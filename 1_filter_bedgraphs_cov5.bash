#!/bin/bash

#PBS -l walltime=8:00:00
#PBS -l select=1:ncpus=2:mem=40gb:scratch_local=15gb
#PBS -N coverage_filtering
#PBS -j oe

# Author: Iris Sammarco
# Date: 03/2025
#
# Purpose:
# Filter all bismark bedgraph coverage files for a minimum coverage (>= 5 reads per position).
# For each input file, outputs a compressed bedgraph file containing only high-coverage positions.
#
# Input:
# - Directory containing bismark genome coverage files (*.bismark.cov.gz).
#   These files are gzipped, typically generated by Bismark, with columns:
#      chromosome, start, end, methylation %, count methylated, count unmethylated
#
# Output:
# - A new directory containing filtered coverage files with suffix '.bismark.cov5.gz'.
#   Filtered files have only rows where (methylated + unmethylated count) >= 5.
#
# Customization:
# - Change INPUT_DIR and OUTPUT_DIR variables below to match your folder structure.
# - Run this script either locally (remove PBS lines) or on HPC as a PBS array or job.
#
# Usage:
# qsub 1_filter_bedgraphs_cov5.sh
# OR
# bash 1_filter_bedgraphs_cov5.sh

# --- User customization ---

INPUT_DIR="/path/to/your/bedgraph_coverage"
OUTPUT_DIR="/path/to/your/bedgraph_coverage_5"

# Create output directory if it does not exist
mkdir -p "$OUTPUT_DIR"

# Process all .bismark.cov.gz files recursively in input folder
find "$INPUT_DIR" -type f -name "*.bismark.cov.gz" | while read FILE; do
    BASENAME=$(basename "$FILE")
    OUTPUT_FILE="$OUTPUT_DIR/${BASENAME%.bismark.cov.gz}.bismark.cov5.gz"

    # Coverage filter: keep only rows with coverage >= 5 (column 5 + column 6)
    zcat "$FILE" | awk '{if (($5 + $6) >= 5) print $0}' | gzip > "$OUTPUT_FILE"
    echo "Processed: $FILE -> $OUTPUT_FILE"
done

# Notes:
# - You can adjust the minimum coverage by changing the number in '($5 + $6) >= 5'.
# - Outputs are ready for downstream DMR calling with metilene or other tools.